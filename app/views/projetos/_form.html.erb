<%= javascript_include_tag :defaults, "nested_form" %>
<%= nested_form_for(@projeto, :validate => true, :html => {"data-type" => :json}) do |f| %>

<div class="div_edit">
    <div class="form-group">
      <h3> Dados do Projeto </h3>
      <div class="container-fluid">
        <div class="row-fluid">
          <div class=" span6">
            <%= f.label :nome %>
            <%= f.text_field :nome, :style => "width: 100%"%>

            <%= f.label :descricao %>
            <%= f.text_area :descricao, :style => "height: 80px; width: 100%"%>
          </div>
          <div class="offset1 span5">
            <%= f.label :data_de_inicio %>
            <%= f.date_select :data_de_inicio, {}, :style => "width: 100px" %>

          </div>
        </div>
      </div>
    </div>
        <div class="form-group">
      <h3> Relacionamento de projetos </h3>
      <div class="container-fluid">
        <div class="row-fluid">
          <div class=" span6">
            <table>
              <tr>
                <th><%= f.label "Super-Projeto" %></th>
                <th style="padding: 0px 20px;"><%= f.label "Sub-Projeto"%></th>
              </tr>
              <tr>
                <td><%= radio_button_tag :super_projeto, true, @eh_super_projeto%></td>
                <td style="padding: 0px 20px;"><%= radio_button_tag :super_projeto, false, !@eh_super_projeto%></td>
              </tr>
            </table>
          </div>

            <div id="filhos">
              <table>
                <tr>
                  <th><%= f.label "filho?", :style => "margin-right: 20%"%></th>
                  <th><%= f.label "projetos filhos" %>                     </th>
                </tr>
                <% @filhos_for_select.each_with_index do |sub, index| %>
                  <tr>
                    <td><%= check_box_tag "sub_projetos[#{index}[filho]", 1, !(@projeto.sub_projetos[index].nil?) %>    </td>
                    <td><%=@filhos_for_select[index][0]%><%= hidden_field_tag "sub_projetos[#{index}[id]]", @filhos_for_select[index][1], :style => "margin-right: 50%"%></td>
                  </tr>
                <%end%>
              </table>
            </div>

            <div class="offset1 span5" id="pai">
              <%= f.label "projeto pai" %>
              <%= f.select :super_projeto_id, options_for_select(@pais_for_select, [@projeto.super_projeto.try(:nome), @projeto.super_projeto_id]), :style => "width: 70%"%>
            </div>

        </div>
      </div>
    </div>
    <div class="form-group">

      <div class="container-fluid">
        <div class="row-fluid">
          <div class="span5">
            <h3> Equipe </h3>
            <input type='text' data-provide="typeahead" class='typeahead' id='autocomplete_field'/>
            <%= f.link_to_add '<i class="icon-plus-sign icon-2x"> </i>'.html_safe , :workons, :class=>"nohover" %>
            <table>
              <tr>
                <th style="padding: 0px 20px;"> Nome </th>
                <th> Remover </th>
                <th></th>
              </tr>
              <%= f.fields_for :workons, :wrapper => false do |worker| %>
                <tr>
                  <td style="padding: 0px 20px;">
                    <%= worker.object.try(:usuario).try(:nome) %>
                    <%= worker.hidden_field :usuario_id %>
                  </td>
                  <td style="margin-left: 10px">
                    <%= worker.link_to_remove '<i class="icon-trash icon-2x"> </i>'.html_safe, :class=>"nohover" %>
                  </td>
                  <td>
                    <%= link_to "Adicionar Coordenadores", edit_workon_path( Workon.select(:id).joins(:usuario).where(:usuario => {:nome => worker.object.usuario.try(:nome)},:projeto_id => @projeto.id ).collect { |u| u.id }) %>
                  </td>
                </tr>
              <% end %>
              <tr id='novo_item'></tr>
            </table>
          </div>
          <div class="offset2 span3">

            <h3> Boards do Trello </h3>
            <div class="loggedout">
              <a class="btn default-button" id="connectLink" onclick="loginTrello(getBoards)"> Conectar ao Trello</a>
            </div>
            <div class="loggedin">
              <div id="output" class="panel-scrollable" style="height: 200px"></div>
            </div>
          </div>
        </div>
      </div>
    </div>
    <div class="actions">
      <%= f.submit "Salvar", :class => "btn default-button"%>
      <%= link_to "Cancelar", projetos_path, :class => "btn default-button" %>
    </div>
  </div>
<% end %>


<script>
  window.NestedFormEvents.prototype.insertFields = function(content, assoc, link) {
    if (assoc == "coordenacoes") {
      var a = $(content).insertBefore($('#novo_item_coordenador'));
      return a;
    }
    else {
      var a = $(content).insertBefore($('#novo_item'));
      //@author rezende, stein
      var tableData = a.children().eq(0);
      var usuario_id_hidden_input = $(document.createElement('input'));
      var new_random_id = a.children().eq(1).children().eq(0).attr('id').split('_')[3];
      nome = ($('#autocomplete_field').val());
      usuario_id_hidden_input.attr('id', 'projeto_workons_attributes_'+new_random_id+'_usuario_id');
      usuario_id_hidden_input.attr('name', 'projeto[workons_attributes]['+new_random_id+'][usuario_id]');
      usuario_id_hidden_input.attr('type', 'hidden');
      $.ajax({
        url: "<%= get_id_by_nome_usuarios_path %>",
        data: {name: nome}, 
        success: function(result) { 
          usuario_id_hidden_input.attr('value', result);
        }
      });
      tableData.text(nome);
      tableData.append(usuario_id_hidden_input);
      return a;
      }
  }
  var segundaPraMim = <%=  @projeto.boards.collect {|b| b.board_id}.to_json.html_safe %>
  checkTrello(getBoards);

  $(document).ready(function() {
    autocomplete_source(<%= @usuarios.collect {|u| u.nome}.to_json.html_safe %>);
    if($("input[name='super_projeto']:checked").val() == "true")
      mostraFilhos();
    else
      mostraPai();
  })

  $("#super_projeto_true").click(function(){
    mostraFilhos();
  });

  $("#super_projeto_false").click(function(){
    mostraPai();
  });

  function mostraPai(){
    $("#filhos").hide(200);
    $("#pai").show(200);
  }

  function mostraFilhos(){
    $("#filhos").show(200);
    $("#pai").hide(200);
  }
</script>
